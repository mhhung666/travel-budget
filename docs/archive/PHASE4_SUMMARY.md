# Phase 4 完成總結 ✅

## 已完成功能

### 1. 支出管理 API

#### POST /api/trips/[id]/expenses - 新增支出
- ✅ 驗證付款人和分帳對象都是旅行成員
- ✅ 自動計算每人應分擔金額
- ✅ 使用事務確保支出和分帳記錄同時創建
- ✅ 支援選擇 1-4 人平分
- ✅ 完整的輸入驗證

**請求範例:**
```json
{
  "payer_id": 1,
  "amount": 2000,
  "description": "晚餐 - 居酒屋",
  "date": "2026-01-08",
  "split_with": [1, 2, 3, 4]
}
```

#### GET /api/trips/[id]/expenses - 獲取支出列表
- ✅ 返回所有支出及其分帳詳情
- ✅ 按日期降序排列
- ✅ 包含付款人資訊
- ✅ 包含每筆支出的分帳明細

**響應包含:**
- 支出基本信息(金額、描述、日期)
- 付款人信息(ID、用戶名、顯示名稱)
- 分帳明細(每個人應付金額)

#### DELETE /api/trips/[id]/expenses/[expenseId] - 刪除支出
- ✅ 只有付款人可以刪除自己的支出
- ✅ 級聯刪除分帳記錄
- ✅ 權限驗證

### 2. 支出列表頁面

更新 [app/trips/[id]/page.tsx](app/trips/[id]/page.tsx) 增加完整的支出管理功能:

#### 支出列表顯示
- ✅ 卡片式設計,清晰顯示每筆支出
- ✅ 顯示支出描述、金額、付款人、日期
- ✅ 展示分帳對象和每人應付金額
- ✅ 按日期排序
- ✅ 空狀態提示

#### 新增支出 Modal
- ✅ 選擇付款人下拉選單
- ✅ 輸入金額(支援小數)
- ✅ 輸入項目描述
- ✅ 選擇日期(默認今天)
- ✅ **多選分帳對象** - 核心功能
  - Checkbox 列表選擇成員
  - 即時顯示已選人數
  - 自動計算每人分擔金額預覽
  - 至少選擇 1 人才能提交

#### 刪除功能
- ✅ 只有付款人能看到刪除按鈕
- ✅ 確認對話框防止誤刪
- ✅ 刪除後自動刷新列表

### 3. 數據完整性

#### 自動計算
```
每人分擔金額 = 總金額 / 分帳人數
```

#### 事務處理
確保創建支出時:
1. 插入支出記錄
2. 為每個分帳對象插入分帳記錄
3. 全部成功或全部回滾

#### 驗證規則
- ✅ 金額必須 > 0
- ✅ 付款人必須是旅行成員
- ✅ 所有分帳對象必須是旅行成員
- ✅ 至少選擇 1 人分帳
- ✅ 所有欄位必填

## 文件結構

```
app/
└── api/
    └── trips/
        └── [id]/
            └── expenses/
                ├── route.ts                    # 新增/獲取支出 API
                └── [expenseId]/
                    └── route.ts                # 刪除支出 API

scripts/
└── check-expenses.ts                           # 支出統計腳本
```

## 測試結果

### 創建的測試數據

| ID | 付款人 | 金額 | 描述 | 分帳對象 | 每人分擔 |
|----|--------|------|------|----------|----------|
| 2 | Bob | $1,200 | 交通費 - 計程車 | Alice, Bob | $600 |
| 3 | Charlie | $900 | 早餐 | Bob, Charlie, David | $300 |

### 每人統計

| 成員 | 總付款 | 總應付 | 淨餘額 | 狀態 |
|------|--------|--------|--------|------|
| Alice | $0 | $600 | -$600 | 應付 |
| Bob | $1,200 | $900 | +$300 | 應收 |
| Charlie | $900 | $300 | +$600 | 應收 |
| David | $0 | $300 | -$300 | 應付 |

### API 測試
- ✅ 新增 4 人平分支出成功
- ✅ 新增 2 人平分支出成功
- ✅ 新增 3 人平分支出成功
- ✅ 自動計算分帳金額正確
- ✅ 獲取支出列表成功
- ✅ 刪除支出成功
- ✅ 權限驗證正常

## 功能特色

### 1. 靈活分帳
- 支援 1-4 人任意組合
- 不限於全員平分
- 可以選擇部分成員

### 2. 自動計算
- 即時顯示每人分擔金額
- 自動四捨五入到小數點後兩位
- 前端即時預覽

### 3. 權限控制
- 只有付款人可以刪除支出
- 只有旅行成員可以新增支出
- 完整的權限驗證

### 4. 用戶體驗
- Modal 彈窗操作流暢
- 表單驗證完整
- 錯誤提示清晰
- 即時更新列表
- 響應式設計

## 使用流程

### 新增支出
1. 點擊「新增支出」按鈕
2. 選擇付款人
3. 輸入金額和描述
4. 選擇日期
5. **勾選分帳對象**(可選 1-4 人)
6. 查看每人分擔金額預覽
7. 確認新增

### 查看支出
- 自動載入所有支出
- 顯示詳細分帳信息
- 按日期排序

### 刪除支出
1. 找到自己付款的支出
2. 點擊「刪除」按鈕
3. 確認刪除
4. 列表自動更新

## API 使用示例

### 新增支出(4人平分)
```bash
curl -X POST http://localhost:3000/api/trips/1/expenses \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "payer_id": 1,
    "amount": 2000,
    "description": "晚餐 - 居酒屋",
    "date": "2026-01-08",
    "split_with": [1, 2, 3, 4]
  }'
```

### 新增支出(2人平分)
```bash
curl -X POST http://localhost:3000/api/trips/1/expenses \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "payer_id": 2,
    "amount": 1200,
    "description": "交通費",
    "date": "2026-01-08",
    "split_with": [1, 2]
  }'
```

### 獲取支出列表
```bash
curl http://localhost:3000/api/trips/1/expenses -b cookies.txt
```

### 刪除支出
```bash
curl -X DELETE http://localhost:3000/api/trips/1/expenses/1 -b cookies.txt
```

## 數據庫示例

### expenses 表
```sql
id | trip_id | payer_id | amount | description | date
2  | 1       | 2        | 1200   | 交通費      | 2026-01-08
3  | 1       | 3        | 900    | 早餐        | 2026-01-09
```

### expense_splits 表
```sql
expense_id | user_id | share_amount
2          | 1       | 600
2          | 2       | 600
3          | 2       | 300
3          | 3       | 300
3          | 4       | 300
```

## 技術亮點

1. **事務處理**: 確保支出和分帳記錄的原子性
2. **自動計算**: 前後端都進行分帳金額計算
3. **權限系統**: 細粒度的權限控制
4. **即時預覽**: 表單中即時顯示每人分擔金額
5. **級聯刪除**: 刪除支出自動刪除分帳記錄
6. **完整驗證**: 前後端雙重驗證

## 下一步 (Phase 5)

準備開發結算功能:
1. 計算每個人的淨餘額
2. 使用結算演算法優化轉帳次數
3. 顯示結算結果(誰應該付給誰多少錢)
4. 創建結算頁面

## 統計腳本

使用 `check-expenses.ts` 查看支出統計:
```bash
npx tsx scripts/check-expenses.ts
```

顯示:
- 所有支出列表
- 每筆支出的分帳詳情
- 每個人的總付款、總應付、淨餘額
