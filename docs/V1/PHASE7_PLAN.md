# Phase 7: æ”¯å‡ºç·¨è¼¯èˆ‡å¤šå¹£åˆ¥åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

æœ¬éšæ®µå°‡ç‚ºæ—…è¡Œåˆ†å¸³ App æ–°å¢å…©å¤§æ ¸å¿ƒåŠŸèƒ½:
1. **æ”¯å‡ºç´€éŒ„ç·¨è¼¯åŠŸèƒ½** - å…è¨±ä»˜æ¬¾äººç·¨è¼¯å·²å»ºç«‹çš„æ”¯å‡ºé …ç›®å’Œé‡‘é¡
2. **å¤šå¹£åˆ¥æ”¯æ´** - æ”¯æ´å¤–å¹£æ”¯å‡ºä¸¦è‡ªå‹•æ›ç®—å›åŸºæº–è²¨å¹£

---

## åŠŸèƒ½éœ€æ±‚

### 1. æ”¯å‡ºç´€éŒ„ç·¨è¼¯åŠŸèƒ½

#### 1.1 å¯ç·¨è¼¯æ¬„ä½
- **é …ç›®æè¿° (description)**: æ–‡å­—æ¬„ä½
- **é‡‘é¡ (amount)**: æ•¸å­—æ¬„ä½

#### 1.2 æ¬Šé™é™åˆ¶
- åªæœ‰**ä»˜æ¬¾äºº (payer)** å¯ä»¥ç·¨è¼¯è‡ªå·±å»ºç«‹çš„æ”¯å‡º
- ä¸€èˆ¬æˆå“¡ç„¡æ³•ç·¨è¼¯ä»–äººçš„æ”¯å‡º
- ç®¡ç†å“¡ä¹Ÿä¸èƒ½ç·¨è¼¯ä»–äººçš„æ”¯å‡º (ä¿æŒå…¬å¹³æ€§)

#### 1.3 ä¸å¯ç·¨è¼¯æ¬„ä½
ä»¥ä¸‹æ¬„ä½åœ¨å»ºç«‹å¾Œ**ä¸å…è¨±ä¿®æ”¹**,ä»¥ç¶­æŒå¸³å‹™ä¸€è‡´æ€§:
- ä»˜æ¬¾äºº (payer_id)
- æ”¯å‡ºæ—¥æœŸ (date)
- åˆ†å¸³å°è±¡ (split_with)

**ç†ç”±**: ä¿®æ”¹é€™äº›æ¬„ä½æœƒå½±éŸ¿çµç®—è¨ˆç®—,å®¹æ˜“é€ æˆå¸³å‹™æ··äº‚ã€‚å¦‚éœ€ä¿®æ”¹,æ‡‰åˆªé™¤åŸæ”¯å‡ºä¸¦é‡æ–°å»ºç«‹ã€‚

#### 1.4 UI/UX è¨­è¨ˆ

**a) ç·¨è¼¯æŒ‰éˆ•ä½ç½®**
- åœ¨æ”¯å‡ºåˆ—è¡¨çš„æ¯ç­†æ”¯å‡ºä¸Šé¡¯ç¤ºã€Œç·¨è¼¯ã€åœ–ç¤º
- åªæœ‰ä»˜æ¬¾äººå¯è¦‹ç·¨è¼¯æŒ‰éˆ•
- ä½¿ç”¨ Material-UI çš„ `EditIcon`

**b) ç·¨è¼¯ Dialog**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç·¨è¼¯æ”¯å‡º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚ é …ç›®æè¿° *                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ™šé¤                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ é‡‘é¡ *                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1500                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ ä»˜æ¬¾äºº: Alice (ä¸å¯ä¿®æ”¹)              â”‚
â”‚ æ—¥æœŸ: 2024-01-15 (ä¸å¯ä¿®æ”¹)           â”‚
â”‚ åˆ†å¸³å°è±¡: Bob, Carol (ä¸å¯ä¿®æ”¹)       â”‚
â”‚                                       â”‚
â”‚         [å–æ¶ˆ]      [å„²å­˜ä¿®æ”¹]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**c) æ¬„ä½é©—è­‰**
- é …ç›®æè¿°ä¸å¯ç‚ºç©º
- é‡‘é¡å¿…é ˆå¤§æ–¼ 0
- é¡¯ç¤ºé©—è­‰éŒ¯èª¤è¨Šæ¯

#### 1.5 æŠ€è¡“å¯¦ç¾

**API Endpoint**
```
PUT /api/trips/[id]/expenses/[expenseId]
```

**è«‹æ±‚åƒæ•¸**
```typescript
{
  description: string;  // å¿…å¡«
  amount: number;       // å¿…å¡«,éœ€ > 0
}
```

**æ¬Šé™æª¢æŸ¥**
1. é©—è­‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æ—…è¡Œæˆå“¡
2. é©—è­‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æ”¯å‡ºçš„ä»˜æ¬¾äºº
3. åªæœ‰ä»˜æ¬¾äººå¯ä»¥ç·¨è¼¯

**è³‡æ–™åº«æ“ä½œ**
```sql
UPDATE expenses
SET description = $1, amount = $2
WHERE id = $3 AND payer_id = $4;
```

**æ³¨æ„**: ä¿®æ”¹é‡‘é¡å¾Œ,éœ€è¦**é‡æ–°è¨ˆç®—åˆ†å¸³é‡‘é¡**
```typescript
// é‡æ–°è¨ˆç®—æ¯äººåˆ†æ“”é‡‘é¡
const shareAmount = amount / splitCount;

// æ›´æ–°æ‰€æœ‰ç›¸é—œçš„ expense_splits
UPDATE expense_splits
SET share_amount = shareAmount
WHERE expense_id = expenseId;
```

---

### 2. å¤šå¹£åˆ¥åŠŸèƒ½

#### 2.1 æ”¯æ´å¹£åˆ¥
- **JPY** - æ—¥åœ“
- **USD** - ç¾å…ƒ
- **EUR** - æ­å…ƒ
- **HKD** - æ¸¯å¹£
- **TWD** - æ–°å°å¹£ (åŸºæº–è²¨å¹£)

#### 2.2 æ•¸æ“šåº« Schema è®Šæ›´

```sql
-- åœ¨ expenses è¡¨æ ¼æ–°å¢å¹£åˆ¥å’ŒåŒ¯ç‡æ¬„ä½
ALTER TABLE expenses ADD COLUMN currency TEXT DEFAULT 'TWD';
ALTER TABLE expenses ADD COLUMN exchange_rate DECIMAL(10, 6) DEFAULT 1.0;
ALTER TABLE expenses ADD COLUMN original_amount DECIMAL(10, 2);

-- currency: å¹£åˆ¥ä»£ç¢¼ (TWD, JPY, USD, EUR, HKD)
-- exchange_rate: å° TWD çš„åŒ¯ç‡ (ä¾‹å¦‚: 1 USD = 31.5 TWD)
-- original_amount: åŸå§‹å¹£åˆ¥é‡‘é¡
-- amount: æ›ç®—å¾Œçš„ TWD é‡‘é¡ (ç”¨æ–¼çµç®—è¨ˆç®—)
```

**æ¬„ä½èªªæ˜**:
- `original_amount`: ä½¿ç”¨è€…è¼¸å…¥çš„åŸå§‹é‡‘é¡ (ä¾‹å¦‚: 1000 JPY)
- `currency`: å¹£åˆ¥ (ä¾‹å¦‚: JPY)
- `exchange_rate`: åŒ¯ç‡ (ä¾‹å¦‚: 0.22,è¡¨ç¤º 1 JPY = 0.22 TWD)
- `amount`: è‡ªå‹•è¨ˆç®—çš„ TWD é‡‘é¡ = original_amount Ã— exchange_rate

#### 2.3 UI è¨­è¨ˆ

**a) æ–°å¢æ”¯å‡º Dialog ä¿®æ”¹**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°å¢æ”¯å‡º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»˜æ¬¾äºº *                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Alice                        â–¼   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ å¹£åˆ¥ *                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ TWD - æ–°å°å¹£                 â–¼   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ é‡‘é¡ *                 åŒ¯ç‡ (å°TWD)   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1000           â”‚   â”‚ 0.22     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚
â”‚ ğŸ’¡ æ›ç®—å¾Œ: 220 TWD                    â”‚
â”‚                                       â”‚
â”‚ é …ç›®æè¿° *                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ åˆé¤                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ æ—¥æœŸ *                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 2024-01-15                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚
â”‚ åˆ†å¸³å°è±¡ *                            â”‚
â”‚ â˜‘ Bob                                â”‚
â”‚ â˜‘ Carol                              â”‚
â”‚                                       â”‚
â”‚ æ¯äººåˆ†æ“”: 110 TWD                     â”‚
â”‚                                       â”‚
â”‚         [å–æ¶ˆ]      [æ–°å¢æ”¯å‡º]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**b) å¹£åˆ¥é¸æ“‡å™¨ (Select Dropdown)**
```typescript
const currencies = [
  { code: 'TWD', name: 'æ–°å°å¹£', symbol: 'NT$' },
  { code: 'JPY', name: 'æ—¥åœ“', symbol: 'Â¥' },
  { code: 'USD', name: 'ç¾å…ƒ', symbol: '$' },
  { code: 'EUR', name: 'æ­å…ƒ', symbol: 'â‚¬' },
  { code: 'HKD', name: 'æ¸¯å¹£', symbol: 'HK$' },
];
```

**c) å‹•æ…‹é¡¯ç¤ºé‚è¼¯**
- é¸æ“‡ TWD: éš±è—åŒ¯ç‡æ¬„ä½ (è‡ªå‹•è¨­ç‚º 1.0)
- é¸æ“‡å…¶ä»–å¹£åˆ¥: é¡¯ç¤ºåŒ¯ç‡è¼¸å…¥æ¬„ä½
- å³æ™‚è¨ˆç®—ä¸¦é¡¯ç¤ºæ›ç®—å¾Œçš„ TWD é‡‘é¡
- å³æ™‚è¨ˆç®—æ¯äººåˆ†æ“”é‡‘é¡ (ä»¥ TWD è¨ˆ)

**d) æ”¯å‡ºåˆ—è¡¨é¡¯ç¤º**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ™šé¤                                  â”‚
â”‚ 1000 JPY (åŒ¯ç‡ 0.22) = 220 TWD       â”‚
â”‚ ä»˜æ¬¾äºº: Alice                         â”‚
â”‚ æ—¥æœŸ: 2024-01-15                      â”‚
â”‚ åˆ†å¸³: Bob (110 TWD), Carol (110 TWD) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è‹¥ç‚º TWD,å‰‡ç°¡åŒ–é¡¯ç¤º:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆé¤                                  â”‚
â”‚ 300 TWD                               â”‚
â”‚ ä»˜æ¬¾äºº: Alice                         â”‚
â”‚ æ—¥æœŸ: 2024-01-15                      â”‚
â”‚ åˆ†å¸³: Bob (150 TWD), Carol (150 TWD) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4 æŠ€è¡“å¯¦ç¾

**a) API ä¿®æ”¹**

**POST /api/trips/[id]/expenses**
```typescript
// æ–°å¢è«‹æ±‚åƒæ•¸
{
  payer_id: number;
  original_amount: number;      // æ–°å¢: åŸå§‹é‡‘é¡
  currency: string;             // æ–°å¢: å¹£åˆ¥ä»£ç¢¼
  exchange_rate?: number;       // æ–°å¢: åŒ¯ç‡ (é¸å¡«,TWD æ™‚å¯çœç•¥)
  description: string;
  date: string;
  split_with: number[];
}

// é©—è­‰é‚è¼¯
- currency å¿…é ˆæ˜¯æ”¯æ´çš„å¹£åˆ¥ä¹‹ä¸€
- è‹¥ currency !== 'TWD',å‰‡ exchange_rate å¿…å¡«ä¸” > 0
- è¨ˆç®— amount = original_amount * exchange_rate
```

**PUT /api/trips/[id]/expenses/[expenseId]**
```typescript
// å…è¨±ç·¨è¼¯çš„æ¬„ä½
{
  description?: string;
  original_amount?: number;
  currency?: string;
  exchange_rate?: number;
}

// ç·¨è¼¯é‚è¼¯
- å¦‚æœä¿®æ”¹äº† original_amount, currency æˆ– exchange_rate
- é‡æ–°è¨ˆç®— amount = original_amount * exchange_rate
- é‡æ–°è¨ˆç®—æ‰€æœ‰ expense_splits çš„ share_amount
```

**b) å‰ç«¯è¨ˆç®—é‚è¼¯**
```typescript
// å³æ™‚æ›ç®—é¡¯ç¤º
const convertedAmount = originalAmount * exchangeRate;
const sharePerPerson = convertedAmount / splitWith.length;

// ç•¶ç”¨æˆ¶ä¿®æ”¹å¹£åˆ¥æ™‚
const handleCurrencyChange = (newCurrency: string) => {
  if (newCurrency === 'TWD') {
    setExchangeRate(1.0);
    setShowExchangeRate(false);
  } else {
    setShowExchangeRate(true);
    // å¯é¸: æä¾›å¸¸ç”¨åŒ¯ç‡å»ºè­°
  }
};
```

**c) çµç®—è¨ˆç®—**
- æ‰€æœ‰æ”¯å‡ºå·²ç¶“æ›ç®—æˆ TWD (å­˜åœ¨ `amount` æ¬„ä½)
- çµç®—è¨ˆç®—é‚è¼¯**ä¸éœ€è¦ä¿®æ”¹**
- ä½¿ç”¨ç¾æœ‰çš„ `calculateSettlement()` å‡½æ•¸

#### 2.5 è³‡æ–™é·ç§»

ç‚ºç¾æœ‰æ”¯å‡ºæ–°å¢é è¨­å€¼:
```sql
-- ç‚ºç¾æœ‰æ”¯å‡ºè¨­å®šé è¨­å€¼
UPDATE expenses
SET currency = 'TWD',
    exchange_rate = 1.0,
    original_amount = amount
WHERE currency IS NULL;
```

---

## å¯¦ç¾æ­¥é©Ÿ

### Step 1: æ•¸æ“šåº« Schema æ›´æ–°
1. åœ¨ Supabase SQL Editor åŸ·è¡Œä»¥ä¸‹ SQL:
   - æ–°å¢ `currency`, `exchange_rate`, `original_amount` æ¬„ä½
   - ç‚ºç¾æœ‰è³‡æ–™è¨­å®šé è¨­å€¼
2. æ›´æ–° TypeScript å‹åˆ¥å®šç¾© (`types/index.ts`)

### Step 2: å¯¦ç¾æ”¯å‡ºç·¨è¼¯ API
1. å»ºç«‹ `PUT /api/trips/[id]/expenses/[expenseId]` ç«¯é»
2. å¯¦ç¾æ¬Šé™æª¢æŸ¥ (åªæœ‰ä»˜æ¬¾äººå¯ç·¨è¼¯)
3. å¯¦ç¾æ¬„ä½é©—è­‰
4. å¯¦ç¾åˆ†å¸³é‡‘é¡é‡æ–°è¨ˆç®—é‚è¼¯

### Step 3: å¯¦ç¾æ”¯å‡ºç·¨è¼¯ UI
1. åœ¨æ”¯å‡ºåˆ—è¡¨æ–°å¢ã€Œç·¨è¼¯ã€æŒ‰éˆ• (åªå°ä»˜æ¬¾äººé¡¯ç¤º)
2. å»ºç«‹ç·¨è¼¯ Dialog å…ƒä»¶
3. å¯¦ç¾è¡¨å–®é©—è­‰èˆ‡æäº¤
4. æ›´æ–°æ”¯å‡ºåˆ—è¡¨é¡¯ç¤º

### Step 4: å¯¦ç¾å¤šå¹£åˆ¥åŠŸèƒ½ - å¾Œç«¯
1. ä¿®æ”¹ `POST /api/trips/[id]/expenses` API
   - æ¥å—æ–°çš„å¹£åˆ¥åƒæ•¸
   - å¯¦ç¾åŒ¯ç‡è¨ˆç®—
   - å„²å­˜åŸå§‹é‡‘é¡å’Œæ›ç®—é‡‘é¡
2. ä¿®æ”¹ `PUT /api/trips/[id]/expenses/[expenseId]` API
   - æ”¯æ´å¹£åˆ¥ä¿®æ”¹
   - é‡æ–°è¨ˆç®—æ›ç®—é‡‘é¡

### Step 5: å¯¦ç¾å¤šå¹£åˆ¥åŠŸèƒ½ - å‰ç«¯
1. æ–°å¢å¹£åˆ¥é¸æ“‡å™¨å…ƒä»¶
2. æ–°å¢åŒ¯ç‡è¼¸å…¥æ¬„ä½
3. å¯¦ç¾å³æ™‚æ›ç®—è¨ˆç®—èˆ‡é¡¯ç¤º
4. ä¿®æ”¹æ”¯å‡ºåˆ—è¡¨é¡¯ç¤ºé‚è¼¯ (é¡¯ç¤ºåŸå§‹é‡‘é¡å’Œæ›ç®—é‡‘é¡)
5. æ›´æ–°æ–°å¢æ”¯å‡º Dialog

### Step 6: æ¸¬è©¦
1. æ¸¬è©¦æ”¯å‡ºç·¨è¼¯åŠŸèƒ½
   - ä»˜æ¬¾äººå¯ä»¥ç·¨è¼¯
   - éä»˜æ¬¾äººç„¡æ³•ç·¨è¼¯
   - é©—è­‰éŒ¯èª¤è™•ç†
2. æ¸¬è©¦å¤šå¹£åˆ¥åŠŸèƒ½
   - æ–°å¢ä¸åŒå¹£åˆ¥æ”¯å‡º
   - é©—è­‰æ›ç®—è¨ˆç®—æ­£ç¢º
   - é©—è­‰çµç®—è¨ˆç®—æ­£ç¢º
3. æ¸¬è©¦ç·¨è¼¯å¤šå¹£åˆ¥æ”¯å‡º
   - ä¿®æ”¹é‡‘é¡
   - ä¿®æ”¹åŒ¯ç‡
   - é©—è­‰é‡æ–°è¨ˆç®—æ­£ç¢º

---

## API è¦æ ¼

### PUT /api/trips/[id]/expenses/[expenseId]

**åŠŸèƒ½**: ç·¨è¼¯æ”¯å‡ºç´€éŒ„

**è«‹æ±‚åƒæ•¸**:
```typescript
{
  description?: string;      // é …ç›®æè¿°
  original_amount?: number;  // åŸå§‹é‡‘é¡
  currency?: string;         // å¹£åˆ¥ä»£ç¢¼
  exchange_rate?: number;    // åŒ¯ç‡
}
```

**æ¬Šé™æª¢æŸ¥**:
1. å¿…é ˆæ˜¯è©²æ—…è¡Œæˆå“¡
2. å¿…é ˆæ˜¯è©²æ”¯å‡ºçš„ä»˜æ¬¾äºº

**é©—è­‰è¦å‰‡**:
- `description` ä¸å¯ç‚ºç©ºå­—ä¸²
- `original_amount` å¿…é ˆ > 0
- `currency` å¿…é ˆæ˜¯ TWD, JPY, USD, EUR, HKD ä¹‹ä¸€
- `currency !== 'TWD'` æ™‚,`exchange_rate` å¿…é ˆ > 0

**å›æ‡‰**:
```typescript
// 200 OK
{
  message: "æ”¯å‡ºå·²æ›´æ–°",
  expense: ExpenseWithDetails
}

// 400 Bad Request
{
  error: "é‡‘é¡å¿…é ˆå¤§æ–¼ 0"
}

// 403 Forbidden
{
  error: "åªæœ‰ä»˜æ¬¾äººå¯ä»¥ç·¨è¼¯æ”¯å‡º"
}

// 404 Not Found
{
  error: "æ‰¾ä¸åˆ°æ­¤æ”¯å‡º"
}
```

---

## å‹åˆ¥å®šç¾©æ›´æ–°

```typescript
// types/index.ts

export interface Expense {
  id: number;
  trip_id: number;
  payer_id: number;
  amount: number;              // TWD æ›ç®—é‡‘é¡
  original_amount: number;     // æ–°å¢: åŸå§‹é‡‘é¡
  currency: string;            // æ–°å¢: å¹£åˆ¥ä»£ç¢¼
  exchange_rate: number;       // æ–°å¢: åŒ¯ç‡
  description: string;
  date: string;
  created_at: string;
}

export interface ExpenseWithDetails extends Expense {
  payer_name: string;
  splits: Array<{
    user_id: number;
    username: string;
    share_amount: number;      // ä»¥ TWD è¨ˆç®—
  }>;
}

// æ–°å¢: å¹£åˆ¥å®šç¾©
export interface Currency {
  code: string;    // TWD, JPY, USD, EUR, HKD
  name: string;    // æ–°å°å¹£, æ—¥åœ“, ç¾å…ƒ, æ­å…ƒ, æ¸¯å¹£
  symbol: string;  // NT$, Â¥, $, â‚¬, HK$
}
```

---

## å®‰å…¨æ€§è€ƒé‡

### 1. æ¬Šé™é©—è­‰
- ç·¨è¼¯æ”¯å‡ºå¿…é ˆåœ¨å¾Œç«¯é©—è­‰ä»˜æ¬¾äººèº«ä»½
- ä¸èƒ½åªä¾è³´å‰ç«¯éš±è—æŒ‰éˆ•

### 2. è¼¸å…¥é©—è­‰
- é‡‘é¡å¿…é ˆç‚ºæ­£æ•¸
- åŒ¯ç‡å¿…é ˆç‚ºæ­£æ•¸
- å¹£åˆ¥ä»£ç¢¼å¿…é ˆåœ¨å…è¨±æ¸…å–®ä¸­

### 3. è³‡æ–™ä¸€è‡´æ€§
- ç·¨è¼¯é‡‘é¡æ™‚å¿…é ˆåŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸é—œçš„ expense_splits
- ä½¿ç”¨è³‡æ–™åº« transaction ç¢ºä¿åŸå­æ€§

---

## UI/UX ç´°ç¯€

### 1. å³æ™‚åé¥‹
- è¼¸å…¥åŒ¯ç‡æ™‚å³æ™‚é¡¯ç¤ºæ›ç®—é‡‘é¡
- è¼¸å…¥é‡‘é¡æ™‚å³æ™‚é¡¯ç¤ºæ¯äººåˆ†æ“”é‡‘é¡
- ä½¿ç”¨ Material-UI çš„ Helper Text é¡¯ç¤ºæç¤º

### 2. é è¨­å€¼å»ºè­°
- æä¾›å¸¸ç”¨åŒ¯ç‡åƒè€ƒ (å¯é¸)
  ```
  JPY: 0.22
  USD: 31.5
  EUR: 34.5
  HKD: 4.0
  ```

### 3. éŒ¯èª¤è™•ç†
- ç¶²è·¯éŒ¯èª¤æç¤º
- é©—è­‰éŒ¯èª¤è¨Šæ¯
- æ¬Šé™ä¸è¶³æç¤º

### 4. æˆåŠŸæç¤º
- ç·¨è¼¯æˆåŠŸé¡¯ç¤º Snackbar
- æ–°å¢æˆåŠŸé¡¯ç¤º Snackbar
- ä½¿ç”¨ç¶ è‰²æˆåŠŸåœ–ç¤º

---

## å¯é¸åŠŸèƒ½ (æœªä¾†æ“´å±•)

### 1. è‡ªå‹•åŒ¯ç‡ API
- ä¸²æ¥å³æ™‚åŒ¯ç‡ API (å¦‚ ExchangeRate-API)
- è‡ªå‹•å¡«å…¥ç•¶æ—¥åŒ¯ç‡
- ä½¿ç”¨è€…ä»å¯æ‰‹å‹•èª¿æ•´

### 2. åŒ¯ç‡æ­·å²è¨˜éŒ„
- è¨˜éŒ„å»ºç«‹æ™‚çš„åŒ¯ç‡
- æ”¯å‡ºåˆ—è¡¨é¡¯ç¤ºå»ºç«‹æ™‚åŒ¯ç‡

### 3. å¤šåŸºæº–è²¨å¹£
- å…è¨±æ¯å€‹æ—…è¡Œè¨­å®šä¸åŒçš„åŸºæº–è²¨å¹£
- æ—¥æœ¬æ—…è¡Œç”¨ JPY,æ­æ´²æ—…è¡Œç”¨ EUR

### 4. æ‰¹æ¬¡ç·¨è¼¯
- ä¸€æ¬¡ä¿®æ”¹å¤šç­†æ”¯å‡º
- æ‰¹æ¬¡èª¿æ•´åŒ¯ç‡

---

## æ³¨æ„äº‹é …

1. **è³‡æ–™ä¸€è‡´æ€§**: ç·¨è¼¯é‡‘é¡å¾Œå¿…é ˆé‡æ–°è¨ˆç®—æ‰€æœ‰åˆ†å¸³è¨˜éŒ„
2. **å‘å¾Œç›¸å®¹æ€§**: ç¾æœ‰æ”¯å‡ºéœ€è¦è¨­å®šé è¨­å¹£åˆ¥ç‚º TWD
3. **ä½¿ç”¨è€…é«”é©—**: åŒ¯ç‡è¼¸å…¥è¦ç›´è¦º,æ›ç®—çµæœè¦æ¸…æ¥šé¡¯ç¤º
4. **æ•ˆèƒ½è€ƒé‡**: å³æ™‚è¨ˆç®—ä¸æ‡‰å½±éŸ¿è¼¸å…¥æµæš¢åº¦
5. **éŒ¯èª¤è™•ç†**: æ‰€æœ‰å¯èƒ½çš„éŒ¯èª¤æƒ…æ³éƒ½è¦æœ‰å‹å–„æç¤º

---

## æª”æ¡ˆä¿®æ”¹æ¸…å–®

### è³‡æ–™åº«
- `scripts/phase7-schema-update.sql` (æ–°å»º)

### å‹åˆ¥å®šç¾©
- `types/index.ts`

### API è·¯ç”±
- `app/api/trips/[id]/expenses/[expenseId]/route.ts` (æ–°å»º PUT endpoint)
- `app/api/trips/[id]/expenses/route.ts` (ä¿®æ”¹ POST endpoint)

### å‰ç«¯é é¢/å…ƒä»¶
- `app/trips/[id]/page.tsx` (ä¿®æ”¹æ”¯å‡ºåˆ—è¡¨å’Œæ–°å¢ Dialog)

---

## é ä¼°å·¥ä½œæ™‚é–“

- Step 1: æ•¸æ“šåº« Schema æ›´æ–° (30 åˆ†é˜)
- Step 2: å¯¦ç¾æ”¯å‡ºç·¨è¼¯ API (1-1.5 å°æ™‚)
- Step 3: å¯¦ç¾æ”¯å‡ºç·¨è¼¯ UI (1.5-2 å°æ™‚)
- Step 4: å¯¦ç¾å¤šå¹£åˆ¥åŠŸèƒ½ - å¾Œç«¯ (1-1.5 å°æ™‚)
- Step 5: å¯¦ç¾å¤šå¹£åˆ¥åŠŸèƒ½ - å‰ç«¯ (2-3 å°æ™‚)
- Step 6: æ¸¬è©¦èˆ‡ä¿®å¾© (1-2 å°æ™‚)

**ç¸½è¨ˆ**: ç´„ 7-10.5 å°æ™‚é–‹ç™¼æ™‚é–“
